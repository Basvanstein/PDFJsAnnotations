var PDFAnnotate=function(t,e,a={}){this.number_of_pages=0,this.pages_rendered=0,this.active_tool=1,this.fabricObjects=[],this.fabricObjectsData=[],this.color="#212121",this.borderColor="#000000",this.borderSize=1,this.font_size=16,this.active_canvas=0,this.container_id=t,this.url=e,this.pageImageCompression=a.pageImageCompression?a.pageImageCompression.toUpperCase():"NONE",this.textBoxText="Sample Text",this.pages=[];var i=this;pdfjsLib.getDocument(this.url).promise.then(function(t){var e=a.scale?a.scale:1.3;i.number_of_pages=t.numPages;for(var n=1;n<=t.numPages;n++)t.getPage(n).then(function(t){i.pages.push(t);var a=t.getViewport({scale:e}),n=document.createElement("canvas");document.getElementById(i.container_id).appendChild(n),n.className="pdf-canvas",n.height=a.height,n.width=a.width,context=n.getContext("2d");var o={canvasContext:context,viewport:a};t.render(o).promise.then(function(){$(".pdf-canvas").each(function(t,e){$(e).attr("id","page-"+(t+1)+"-canvas")}),i.pages_rendered++,i.pages_rendered==i.number_of_pages&&i.initFabric()})})},function(t){console.error(t)}),this.initFabric=function(){var t=this;let e=$("#"+t.container_id+" canvas");e.each(function(i,n){var o=n.toDataURL("image/png"),r=new fabric.Canvas(n.id,{freeDrawingBrush:{width:1,color:t.color}});t.fabricObjects.push(r),"function"==typeof a.onPageUpdated&&r.on("object:added",function(){var e=Object.assign({},t.fabricObjectsData[i]);t.fabricObjectsData[i]=r.toJSON(),a.onPageUpdated(i+1,e,t.fabricObjectsData[i])}),r.setBackgroundImage(o,r.renderAll.bind(r)),$(r.upperCanvasEl).click(function(e){t.active_canvas=i,t.fabricClickHandler(e,r)}),r.on("after:render",function(){t.fabricObjectsData[i]=r.toJSON(),r.off("after:render")}),i===e.length-1&&"function"==typeof a.ready&&a.ready()})},this.fabricClickHandler=function(t,e){if(2==this.active_tool){var a=new fabric.IText(this.textBoxText,{left:t.clientX-e.upperCanvasEl.getBoundingClientRect().left,top:t.clientY-e.upperCanvasEl.getBoundingClientRect().top,fill:this.color,fontSize:this.font_size,selectable:!0});e.add(a),this.active_tool=0}}};PDFAnnotate.prototype.enableSelector=function(){this.active_tool=0,this.fabricObjects.length>0&&$.each(this.fabricObjects,function(t,e){e.isDrawingMode=!1})},PDFAnnotate.prototype.enablePencil=function(){this.active_tool=1,this.fabricObjects.length>0&&$.each(this.fabricObjects,function(t,e){e.isDrawingMode=!0})},PDFAnnotate.prototype.enableAddText=function(t){this.active_tool=2,"string"==typeof t&&(this.textBoxText=t),this.fabricObjects.length>0&&$.each(this.fabricObjects,function(t,e){e.isDrawingMode=!1})},PDFAnnotate.prototype.enableRectangle=function(){var t=this.fabricObjects[this.active_canvas];this.active_tool=4,this.fabricObjects.length>0&&$.each(this.fabricObjects,function(t,e){e.isDrawingMode=!1});var e=new fabric.Rect({width:100,height:100,fill:this.color,stroke:this.borderColor,strokeSize:this.borderSize});t.add(e)},PDFAnnotate.prototype.enableAddArrow=function(){var t=this;t.active_tool=3,t.fabricObjects.length>0&&$.each(t.fabricObjects,function(e,a){a.isDrawingMode=!1,new Arrow(a,t.color,function(){t.active_tool=0})})},PDFAnnotate.prototype.addImageToCanvas=function(){var t=this.fabricObjects[this.active_canvas];if(t){var e=document.createElement("input");e.type="file",e.accept=".jpg,.jpeg,.png,.PNG,.JPG,.JPEG",e.onchange=function(){var a=new FileReader;a.addEventListener("load",function(){e.remove();var a=new Image;a.onload=function(){t.add(new fabric.Image(a))},a.src=this.result},!1),a.readAsDataURL(e.files[0])},document.getElementsByTagName("body")[0].appendChild(e),e.click()}},PDFAnnotate.prototype.deleteSelectedObject=function(){var t=this.fabricObjects[this.active_canvas].getActiveObject();t&&confirm("Are you sure ?")&&this.fabricObjects[this.active_canvas].remove(t)},PDFAnnotate.prototype.savePdf=function(t){var e=this,a=e.format||"a4",i=e.orientation||"portrait";if(e.pages.length>0){var n=e.pages[0].getViewport({scale:1});a=[n.width,n.height],i=n.width>n.height?"landscape":"portrait"}if(e.format=a,e.orientation=i,e.fabricObjects.length){var o=new jspdf.jsPDF({format:a,orientation:i});void 0===t&&(t=`${(new Date).getTime()}.pdf`),e.fabricObjects.forEach(function(n,r){0!=r&&(o.addPage(a,i),o.setPage(r+1)),o.addImage(n.toDataURL({format:"png"}),"NONE"==e.pageImageCompression?"PNG":"JPEG",0,0,o.internal.pageSize.getWidth(),o.internal.pageSize.getHeight(),`page-${r+1}`,["FAST","MEDIUM","SLOW"].indexOf(e.pageImageCompression)>=0?e.pageImageCompression:void 0),r===e.fabricObjects.length-1&&o.save(t)})}},PDFAnnotate.prototype.setBrushSize=function(t){$.each(this.fabricObjects,function(e,a){a.freeDrawingBrush.width=t})},PDFAnnotate.prototype.setColor=function(t){this.color=t,$.each(this.fabricObjects,function(e,a){a.freeDrawingBrush.color=t})},PDFAnnotate.prototype.setBorderColor=function(t){this.borderColor=t},PDFAnnotate.prototype.setFontSize=function(t){this.font_size=t},PDFAnnotate.prototype.setBorderSize=function(t){this.borderSize=t},PDFAnnotate.prototype.clearActivePage=function(){var t=this.fabricObjects[this.active_canvas],e=t.backgroundImage;confirm("Are you sure?")&&(t.clear(),t.setBackgroundImage(e,t.renderAll.bind(t)))},PDFAnnotate.prototype.serializePdf=function(){var t={page_setup:{format:this.format,orientation:this.orientation},pages:this.fabricObjects};return JSON.stringify(t,null,4)},PDFAnnotate.prototype.loadFromJSON=function(t){var e=this,{page_setup:a,pages:i}=t;void 0===i&&(i=t),"object"==typeof a&&"string"==typeof a.format&&"string"==typeof a.orientation&&(e.format=a.format,e.orientation=a.orientation),$.each(e.fabricObjects,function(t,a){i.length>t&&a.loadFromJSON(i[t],function(){e.fabricObjectsData[t]=a.toJSON()})})},PDFAnnotate.prototype.setDefaultTextForTextBox=function(t){"string"==typeof t&&(this.textBoxText=t)};